name: Build TWRP

on:
  workflow_dispatch:
    inputs:
      device_codename:
        description: 'Device codename'
        required: true
      twrp_branch:
        description: 'TWRP branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-11
          - twrp-13
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-twrp.yml'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Validate inputs
      run: |
        echo "Device codename: ${{ github.event.inputs.device_codename }}"
        echo "TWRP branch: ${{ github.event.inputs.twrp_branch }}"
        if [ -z "${{ github.event.inputs.device_codename }}" ]; then
          echo "ERROR: device_codename is required"
          exit 1
        fi
        if [ -z "${{ github.event.inputs.twrp_branch }}" ]; then
          echo "ERROR: twrp_branch is required"
          exit 1
        fi
    
    - name: Checkout device tree
      uses: actions/checkout@v4
      with:
        path: device
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses-dev \
          lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync \
          schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python-is-python3 \
          openjdk-11-jdk
          
    - name: Setup repo
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
    - name: Initialize repo
      run: |
        mkdir twrp && cd twrp
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        BRANCH="${{ github.event.inputs.twrp_branch }}"
        echo "Building for TWRP branch: $BRANCH"
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b "$BRANCH"
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
        
    - name: Clone device tree
      run: |
        cd twrp
        MANUFACTURER=$(grep 'PRODUCT_MANUFACTURER' ../device/twrp_*.mk | cut -d'=' -f2 | tr -d ' ' | tr '[:upper:]' '[:lower:]')
        mkdir -p device/$MANUFACTURER/${{ github.event.inputs.device_codename }}
        cp -r ../device/* device/$MANUFACTURER/${{ github.event.inputs.device_codename }}/
        
    - name: Build TWRP
      run: |
        cd twrp
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        lunch twrp_${{ github.event.inputs.device_codename }}-eng
        mka recoveryimage -j$(nproc --all)
        
    - name: Upload recovery
      uses: actions/upload-artifact@v4
      with:
        name: twrp-${{ github.event.inputs.device_codename }}
        path: |
          twrp/out/target/product/${{ github.event.inputs.device_codename }}/recovery.img
          twrp/out/target/product/${{ github.event.inputs.device_codename }}/vendor_boot.img
        if-no-files-found: ignore
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: twrp-${{ github.event.inputs.device_codename }}-${{ github.run_number }}
        files: |
          twrp/out/target/product/${{ github.event.inputs.device_codename }}/recovery.img
          twrp/out/target/product/${{ github.event.inputs.device_codename }}/vendor_boot.img