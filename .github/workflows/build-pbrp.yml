name: Build PBRP/TWRP

on:
  workflow_dispatch:
    inputs:
      device_codename:
        description: 'Device Codename (e.g., X6885)'
        required: true
        default: 'X6885'
      device_manufacturer:
        description: 'Manufacturer (infinix/tecno/itel)'
        required: true
        default: 'infinix'
      build_type:
        description: 'Build Type'
        required: true
        default: 'vendorboot'
        type: choice
        options:
          - vendorboot
          - recovery
          - boot
      use_uploaded_files:
        description: 'Use uploaded device files?'
        required: true
        default: true
        type: boolean

env:
  MANIFEST_URL: https://github.com/PitchBlackRecoveryProject/manifest_pb
  MANIFEST_BRANCH: android-12.1
  TZ: Asia/Jakarta

jobs:
  prepare-files:
    runs-on: ubuntu-latest
    outputs:
      has_files: ${{ steps.check-files.outputs.has_files }}
      codename: ${{ steps.vars.outputs.codename }}
      manufacturer: ${{ steps.vars.outputs.manufacturer }}
    
    steps:
      - name: Checkout Device Tree
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Variables
        id: vars
        run: |
          echo "codename=${{ github.event.inputs.device_codename }}" >> $GITHUB_OUTPUT
          echo "manufacturer=${{ github.event.inputs.device_manufacturer }}" >> $GITHUB_OUTPUT

      # ==========================================
      # OPSI 1: File di Repository (device-files/)
      # ==========================================
      - name: Check Repository Files
        id: check-files
        run: |
          if [ -f "device-files/vendor_boot.img" ]; then
            echo "âœ… Found vendor_boot.img in device-files/"
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ vendor_boot.img not found in device-files/"
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      # ==========================================
      # OPSI 2: Upload File Manual (Artifacts)
      # ==========================================
      - name: Upload Device Files as Artifacts
        if: steps.check-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: device-files-${{ github.event.inputs.device_codename }}
          path: |
            device-files/*
            !device-files/*.md
          retention-days: 1

  build:
    runs-on: ubuntu-22.04
    needs: prepare-files
    timeout-minutes: 120
    
    steps:
      - name: Checkout Device Tree
        uses: actions/checkout@v4

      # ==========================================
      # DOWNLOAD FILE DARI REPO ATAU INPUT
      # ==========================================
      - name: Setup Device Files Directory
        run: |
          mkdir -p ${{ github.workspace }}/device-files
          
          # Jika ada di repo, copy ke workspace
          if [ -d "${{ github.workspace }}/device-files" ] && [ "$(ls -A ${{ github.workspace }}/device-files/*.img 2>/dev/null)" ]; then
            echo "âœ… Using files from repository"
          else
            echo "âš ï¸ No files in repository, please upload manually"
          fi

      # ==========================================
      # OPSI 3: Download dari URL (Google Drive/Direct Link)
      # ==========================================
      - name: Download Device Files from URL (Optional)
        if: false  # Set true jika ingin pakai
        run: |
          # Contoh download dari direct link
          # wget -O device-files/vendor_boot.img "YOUR_DIRECT_LINK"
          
          # Atau dari GitHub Releases lain
          # wget -O device-files/vendor_boot.img "https://github.com/.../vendor_boot.img"
          
          echo "Download complete"

      - name: Verify Device Files
        run: |
          echo "ðŸ“‚ Checking device files..."
          ls -lh ${{ github.workspace }}/device-files/ || echo "No files yet"
          
          if [ -f "${{ github.workspace }}/device-files/vendor_boot.img" ]; then
            echo "âœ… vendor_boot.img found"
            echo "Size: $(du -h ${{ github.workspace }}/device-files/vendor_boot.img | cut -f1)"
            
            # Verifikasi magic bytes
            MAGIC=$(xxd -l 8 ${{ github.workspace }}/device-files/vendor_boot.img | head -1)
            echo "Magic bytes: $MAGIC"
          else
            echo "âŒ vendor_boot.img not found!"
            echo "Please place vendor_boot.img in device-files/ directory"
            exit 1
          fi

      # ==========================================
      # SETUP BUILD ENVIRONMENT
      # ==========================================
      - name: Setup Build Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            imagemagick lib32ncurses5-dev lib32readline-dev \
            lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libssl-dev libwxgtk3.0-gtk3-dev \
            libxml2 libxml2-utils lzop pngcrush rsync \
            schedtool squashfs-tools xsltproc zip zlib1g-dev \
            libncurses5 python3 python-is-python3 xxd
            
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          
          ccache -M 20G

      # ==========================================
      # SYNC PBRP SOURCE
      # ==========================================
      - name: Sync PBRP Source
        run: |
          mkdir -p ${{ github.workspace }}/workspace
          cd ${{ github.workspace }}/workspace
          
          repo init --depth=1 -u ${{ env.MANIFEST_URL }} -b ${{ env.MANIFEST_BRANCH }} --git-lfs
          repo sync -c --force-sync --optimized-fetch --no-tags --no-clone-bundle --prune -j$(nproc --all)

      # ==========================================
      # EXTRACT VENDOR_BOOT & GENERATE DEVICE TREE
      # ==========================================
      - name: Generate Device Tree from vendor_boot
        run: |
          CODENAME="${{ github.event.inputs.device_codename }}"
          MANUFACTURER="${{ github.event.inputs.device_manufacturer }}"
          DEVICE_PATH="${{ github.workspace }}/workspace/device/$MANUFACTURER/$CODENAME"
          
          mkdir -p $DEVICE_PATH
          
          # Copy generator script
          cp ${{ github.workspace }}/transsion_pbrp_gen.py ${{ github.workspace }}/workspace/
          
          # Run generator dengan vendor_boot.img
          cd ${{ github.workspace }}/workspace
          
          if [ -f "${{ github.workspace }}/device-files/vendor_boot.img" ]; then
            echo "ðŸ”§ Generating device tree from vendor_boot.img..."
            python3 transsion_pbrp_gen.py \
              "${{ github.workspace }}/device-files/vendor_boot.img" \
              -o ${{ github.workspace }}/workspace/device \
              --device-name "${MANUFACTURER}-${CODENAME}"
          else
            echo "âŒ vendor_boot.img not found!"
            exit 1
          fi
          
          # Copy additional files if exist
          if [ -f "${{ github.workspace }}/device-files/dtb.img" ]; then
            cp ${{ github.workspace }}/device-files/dtb.img $DEVICE_PATH/prebuilt/
          fi
          
          if [ -f "${{ github.workspace }}/device-files/kernel" ]; then
            cp ${{ github.workspace }}/device-files/kernel $DEVICE_PATH/prebuilt/
          fi

      # ==========================================
      # BUILD PBRP
      # ==========================================
      - name: Build PBRP
        run: |
          cd ${{ github.workspace }}/workspace
          
          CODENAME="${{ github.event.inputs.device_codename }}"
          
          source build/envsetup.sh
          lunch pb_${CODENAME}-eng
          
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          
          mka -j$(nproc --all) ${{ github.event.inputs.build_type }}image

      # ==========================================
      # PACKAGE OUTPUT
      # ==========================================
      - name: Package Output
        run: |
          CODENAME="${{ github.event.inputs.device_codename }}"
          OUT_DIR="${{ github.workspace }}/workspace/out/target/product/$CODENAME"
          PKG_DIR="${{ github.workspace }}/output"
          
          mkdir -p $PKG_DIR
          
          # Copy semua image yang dihasilkan
          for img in vendor_boot recovery boot; do
            if [ -f "$OUT_DIR/${img}.img" ]; then
              cp "$OUT_DIR/${img}.img" "$PKG_DIR/"
              echo "âœ… Copied ${img}.img"
            fi
          done
          
          # Create flashable zip (optional)
          cd $PKG_DIR
          cat > flash.sh << 'EOF'
          #!/bin/bash
          # Flash script for PBRP
          fastboot flash vendor_boot vendor_boot.img
          fastboot reboot recovery
          EOF
          chmod +x flash.sh
          
          # Create info
          cat > build-info.txt << EOF
          Device: ${{ github.event.inputs.device_manufacturer }} ${{ github.event.inputs.device_codename }}
          Build Date: $(date)
          Build Type: ${{ github.event.inputs.build_type }}
          PBRP Branch: ${{ env.MANIFEST_BRANCH }}
          EOF

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PBRP-${{ github.event.inputs.device_codename }}-${{ github.run_number }}
          path: ${{ github.workspace }}/output/*
          retention-days: 30

      - name: Create Release
        if: github.event.inputs.build_type == 'vendorboot'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: PBRP-${{ github.event.inputs.device_codename }}-${{ github.run_number }}
          name: PBRP ${{ github.event.inputs.device_codename }} Build ${{ github.run_number }}
          body: |
            ## PBRP for ${{ github.event.inputs.device_manufacturer }} ${{ github.event.inputs.device_codename }}
            
            ### Files Included
            - `vendor_boot.img` - Flash to vendor_boot partition
            - `flash.sh` - Helper script for Linux/Mac
            
            ### Installation
            ```bash
            fastboot flash vendor_boot vendor_boot.img
            fastboot reboot recovery
            ```
            
            ### Build Info
            - Date: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
          files: ${{ github.workspace }}/output/*
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
