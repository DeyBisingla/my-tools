name: Generate Device Tree

on:
  workflow_dispatch:
    inputs:
      vendor_boot_url:
        description: 'URL vendor_boot.img'
        required: true
      device_name:
        description: 'Device name (optional)'
        required: false
      extract_first:
        description: 'Extract vendor_boot dulu dengan magiskboot'
        type: boolean
        default: true

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cpio gzip unzip wget
        
    - name: Download Magiskboot
      if: github.event.inputs.extract_first == 'true'
      run: |
        wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
        unzip -j Magisk-v27.0.apk lib/x86_64/libmagiskboot.so -d .
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
    
    - name: Verify script exists
      run: |
        if [ ! -f "transsion_twrp_gen_vendor_boot.py" ]; then
          echo "ERROR: transsion_twrp_gen_vendor_boot.py tidak ditemukan!"
          echo "Upload script ke root repo terlebih dahulu"
          exit 1
        fi
        
    - name: Download vendor_boot
      run: |
        wget -O vendor_boot.img "${{ github.event.inputs.vendor_boot_url }}"
        
    - name: Extract vendor_boot
      if: github.event.inputs.extract_first == 'true'
      run: |
        mkdir -p unpacked_vendor_boot
        cd unpacked_vendor_boot
        ../magiskboot unpack ../vendor_boot.img
        
        echo "=== After magiskboot unpack ==="
        ls -la
        
        if [ -f ramdisk.cpio ]; then
          mkdir ramdisk
          cd ramdisk
          cpio -idm < ../ramdisk.cpio 2>/dev/null || true
          echo "=== After cpio extract ==="
          ls -la
          cd ..
        else
          echo "WARNING: ramdisk.cpio not found"
        fi
        
        cd ..
        echo "=== Final unpacked_vendor_boot contents ==="
        find unpacked_vendor_boot -type f | head -20
        
    - name: Generate device tree
      run: |
        if [ "${{ github.event.inputs.extract_first }}" == "true" ]; then
          INPUT_PATH="unpacked_vendor_boot"
        else
          INPUT_PATH="vendor_boot.img"
        fi
        
        echo "=== Input path: $INPUT_PATH ==="
        ls -la "$INPUT_PATH" || echo "Path not found"
        
        if [ -n "${{ github.event.inputs.device_name }}" ]; then
          python transsion_twrp_gen_vendor_boot.py "$INPUT_PATH" -o output --device-name "${{ github.event.inputs.device_name }}" -v
        else
          python transsion_twrp_gen_vendor_boot.py "$INPUT_PATH" -o output -v
        fi
        
        echo "=== Generation complete, checking output ==="
        ls -la output/ || echo "No output generated"
        
    - name: Check output
      run: |
        echo "=== Checking output directory ==="
        ls -la output/ || echo "output/ not found"
        if [ -d "output/TWRP" ]; then
          ls -la output/TWRP/
        else
          echo "output/TWRP/ not found, checking alternatives..."
          find output -type d 2>/dev/null || true
        fi
        
    - name: Upload device tree
      uses: actions/upload-artifact@v4
      with:
        name: device-tree
        path: output/
        if-no-files-found: warn
        
    - name: Create commit
      continue-on-error: true
      run: |
        if [ -d "output/TWRP" ]; then
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          cp -r output/TWRP/* .
          git add .
          git commit -m "Auto: Generate device tree from vendor_boot" || echo "No changes to commit"
          git push || echo "Nothing to push"
        else
          echo "output/TWRP/ not found, skipping commit"
        fi