name: Generate Device Tree

on:
  workflow_dispatch:
    inputs:
      vendor_boot_url:
        description: 'URL vendor_boot.img'
        required: true
      device_name:
        description: 'Device name (optional)'
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Download vendor_boot
      run: |
        wget -O vendor_boot.img "${{ github.event.inputs.vendor_boot_url }}"
        
    - name: Generate device tree
      run: |
        if [ -n "${{ github.event.inputs.device_name }}" ]; then
          python transsion_twrp_gen_vendor_boot.py vendor_boot.img -o output --device-name "${{ github.event.inputs.device_name }}"
        else
          python transsion_twrp_gen_vendor_boot.py vendor_boot.img -o output
        fi
        
    - name: Upload device tree
      uses: actions/upload-artifact@v4
      with:
        name: device-tree
        path: output/
        
    - name: Create commit
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        cp -r output/TWRP/* .
        git add .
        git commit -m "Auto: Generate device tree from vendor_boot" || echo "No changes"
        git push || echo "Nothing to push"
